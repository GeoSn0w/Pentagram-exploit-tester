//
//  ViewController.m
//  Pentagram
//
//  Created by GeoSn0w on 3/18/22.
//

#import "ViewController.h"
#include "Exploit/desc_race.h"
#import <sys/sysctl.h>
#include "Exploit/spray_stuff.h"

@interface ViewController ()

@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    
}

- (void) viewDidAppear:(BOOL)animated {
    uint64_t mem;
    size_t len = sizeof(uint64_t);
    sysctlbyname("hw.memsize", &mem, &len, NULL, 0);
    printf("Mem: %lld\n", mem);
    
    if (mem >= 4100000000) {
        DeviceIs4GB = false;
        UIAlertController *alertvc=[UIAlertController alertControllerWithTitle:@"Information" message:@"This device has more than 4GB of RAM. Will use Tihmstar's fork of the exploit." preferredStyle:UIAlertControllerStyleAlert];
        UIAlertAction * action = [UIAlertAction actionWithTitle: @ "Dismiss"
                                    style: UIAlertActionStyleDefault handler: ^ (UIAlertAction * _Nonnull action) {
                                      
                                    }
                                   ];
          [alertvc addAction: action];
        [self presentViewController: alertvc animated: true completion: nil];
    
    } else if (mem <= 4100000000 && mem > 2385486592) {
        DeviceIs4GB = true;
        UIAlertController *alertvc=[UIAlertController alertControllerWithTitle:@"Information" message:@"This device has 4GB of RAM. Will use BinaryBoy's version of the exploit." preferredStyle:UIAlertControllerStyleAlert];
        UIAlertAction * action = [UIAlertAction actionWithTitle: @ "Dismiss"
                                    style: UIAlertActionStyleDefault handler: ^ (UIAlertAction * _Nonnull action) {
                                      
                                    }
                                   ];
          [alertvc addAction: action];
        [self presentViewController: alertvc animated: true completion: nil];
        
    } else if (mem <= 2385486592){
        UIAlertController *alertvc=[UIAlertController alertControllerWithTitle:@"Oops..." message:@"This exploit does not currently work on 2GB or lower devices. For that, you'll need to use Jake James' exploit for the same bug." preferredStyle:UIAlertControllerStyleAlert];
        [self presentViewController: alertvc animated: true completion: nil];
    }

}

- (IBAction)runExploit:(id)sender {
    if (desc_race() == 0){
        UIAlertController *alertvc=[UIAlertController alertControllerWithTitle:@"Exploit seems to work!" message:@"Exploit succeeded, and pipe write also worked. This device on this particular iOS version appears to be compatible with this exploit. Do not update your device! Close the app to reboot now and clean up. If it doesn't reboot by itself, please reboot manually." preferredStyle:UIAlertControllerStyleAlert];
        [self presentViewController: alertvc animated: true completion: nil];
    } else if (desc_race() == -3){
        UIAlertController *alertvc=[UIAlertController alertControllerWithTitle:@"An issue occured." message:@"Exploit failed because pipe leak failed. It's possible the device is running an incompatible iOS version, but still, reboot and try again a few more times. Exploit isn't 100% foolproof." preferredStyle:UIAlertControllerStyleAlert];
        [self presentViewController: alertvc animated: true completion: nil];
    } else if (desc_race() == -1){
        UIAlertController *alertvc=[UIAlertController alertControllerWithTitle:@"An issue occured." message:@"Exploit failed because Pipe Write failed. It's possible the device is running an incompatible iOS version, but still, reboot and try again a few more times. Exploit isn't 100% foolproof." preferredStyle:UIAlertControllerStyleAlert];
        [self presentViewController: alertvc animated: true completion: nil];
    } else if (desc_race() == -1){
        UIAlertController *alertvc=[UIAlertController alertControllerWithTitle:@"An issue occured." message:@"Exploit failed because Pipe Spray failed. It's possible the device is running an incompatible iOS version, but still, reboot and try again a few more times. Exploit isn't 100% foolproof." preferredStyle:UIAlertControllerStyleAlert];
        [self presentViewController: alertvc animated: true completion: nil];
    } else if (desc_race() == 1){
        UIAlertController *alertvc=[UIAlertController alertControllerWithTitle:@"An issue occured." message:@"Exploit failed due to an unhandled error. It's possible the device is running an incompatible iOS version, but still, reboot and try again a few more times. Exploit isn't 100% foolproof." preferredStyle:UIAlertControllerStyleAlert];
        [self presentViewController: alertvc animated: true completion: nil];
    }
}


@end
